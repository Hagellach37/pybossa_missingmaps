<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            Well done! Your answer was saved.
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            The task has been finished! Many thanks!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            Congratulations! You have participated on all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or take a look at other projects</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            An error occurred! Please contact the site administrators!
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!-- see http://stackoverflow.com/questions/12121090/responsively-change-div-size-keeping-aspect-ratio -->
<style>
.wrapper {
  width: 100%;
  display: inline-block;
  position: relative;
}
.wrapper:after {
  padding-top: 50%;
  /* 2:1 ratio */
  display: block;
  content: '';
}
.main {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  left: 0;
}

</style>

<!-- Start Skeleton Row-->
<div class="row skeleton"> 
    <!-- Start of Question, Photo and Submission DIV -->
    <div class="span12">
        <!-- The question will be loaded here -->
        <h1 id="question">Can you see human settlements or roads in the satellite imagery?</h1>
        
        <!-- Photo DIV -->
		
        <div class="wrapper" style="background-color:blue">
            <div class="main" id="openlayers_map" style="background-color:grey"></div>
        </div>
        
        <!-- Start DIV for the submission buttons -->
        <div id="answer"> 
            <!-- If the user clicks this button, the saved answer will be value="many"-->
            <button class="btn btn-success btn-answer" value='Yes' id='Sub_Yes'><i class="icon icon-white icon-thumbs-up"></i>Yes</button>
            <!-- If the user clicks this button, the saved answer will be value="no"-->
            <button class="btn btn-danger btn-answer" value='No' id='Sub_No'><i class="icon icon-white icon-thumbs-down"></i>No</button>
            <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
            <button class="btn btn-inverse btn-answer" value='NoPhoto' id='Sub_NoPhoto'><i class="icon icon-exclamation"></i>No/Bad imagery</button>
        </div><!-- End of DIV for the submission buttons -->
              
        <!-- Feedback items for the user -->
        <p>You are working on task: <span id="task-id" class="label label-warning">#</span></p>
        <!-- Progress bar for the user -->
        <!-- <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="height: 0%;"></div>
        </div> -->
        
        <!-- Information area that may be expanded -->
        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#information">Show/Hide additional information</button>
    </div><!-- End of Question, Photo and Submission DIV (column) -->
</div><!-- End of Skeleton Row -->  

<!-- Start of Information DIV -->
<div class="row">    
    <div class="span8.offset2, collapse" id="information">
        <h1>Additional information</h1>
        <p>Help <a href="http://www.missingmaps.org/">Missing Maps</a> to map human settlements and roads in South Kivu, Congo (DRC).</p>
        <p>In case of any problems or questions please contact <a href="Herfort@stud.uni-heidelberg.de">Herfort@stud.uni-heidelberg.de</a></p>
        <h2>What do human settlements and roads look like?</h2> 
        <a href="/uploads/user_3/examples_res_areas.png"><img src="/uploads/user_3/examples_res_areas.png" alt="help" width="800"></a>
        <h2>Hints</h2>
        <ul>
            <li><b>Short-cuts</b>: You may use short-cuts in order to speed up the questionare:<br>
                A or Y for "Yes", W or N for "No", D or B for "No/Bad Imagery"
            <li><b>Additional functionality</b>: Additional functionality can be activated by double clicking on the map.
			<ul><li><b>Zooming</b>: You may zoom the map by using the mouse-wheel or using <b>+</b> and <b>-</b> keys</li>
            <li><b>Moving</b>: You may navigate the map by dragging it with the mouse or using the <b>←</b> <b>→</b> <b>↑</b> <b>↓</b> keys.</li><ul>
        <ul>
    </div>
</div><!-- End of Information Row -->

<script src="http://openlayers.org/en/v3.7.0/build/ol.js" type="text/javascript"></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.7.0/css/ol.css" type="text/css">

<script>
function show_map(wktP,X,Y){
    console.log("map should be shown");
    
    var wkt = wktP;
    var x_center = X;
    var y_center = Y;
    
	// create features from wkt format
    var vects = new ol.source.Vector();
    var format = new ol.format.WKT();
	var feature = format.readFeature(wkt);
    vects.addFeature(feature);
    
	// define feature style, color = red and outline width = 3
    var style_features = new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'rgba(255,0,0,1.0)',
            width: 3
        })
    });
	// create vector layer containing features created before
    var features_layer = new ol.layer.Vector({
        source: vects,
        style: style_features
    }); 
	
	// add background layer, currently using Bing Aerial imagery
    var Bing_layer = new ol.layer.Tile({
        source: new ol.source.BingMaps({
            key: 'Ak-dzM4wZjSqTlzveKz5u0d4IQ4bRzVI309GxmkgSVr1ewS6iPSrOvOKhA-CJlm3',
            imagerySet: 'Aerial'
        })
    });
	// define zoom level and map center
    var map_view = new ol.View({
        center: [x_center,y_center],
        zoom: 17,
        minZoom: 16
    });
	
	// define interaction
	var dblclick_zoom = new ol.interaction.DoubleClickZoom();
	var mouse_wheel_zoom = new ol.interaction.MouseWheelZoom();
	var drag_pan = new ol.interaction.DragPan();
	var key_board_pan = new ol.interaction.KeyboardPan();
	var key_board_zoom = new ol.interaction.KeyboardZoom();
	
	// create new map
    var map = new ol.Map({
        view: map_view,
		controls: ol.control.defaults({zoom:false, rotate:false, attribution:false}),
		interactions: [dblclick_zoom],
        layers: [Bing_layer, features_layer],
        target: 'openlayers_map',
        keyboardEventTarget: document
    });
	
	// add scale line to map
	var myScaleLine = new ol.control.ScaleLine();
	map.addControl(myScaleLine);
	
	// additional functionality is added after dblclick on map
	map.once('dblclick', function() {
		map.addInteraction(drag_pan);
		map.addInteraction(key_board_pan);
		map.addInteraction(key_board_zoom);
		map.addInteraction(mouse_wheel_zoom);		
	});
	
}

function loadUserProgress() {
    pybossa.userProgress('missing_maps_follow_up').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("height", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
    });
}

pybossa.taskLoaded(function(task, deferred) {
    console.log("task was loaded");
    if (!$.isEmptyObject(task) ) {
        console.log("task is not empty")
        console.log(task.info.WKT);
    }
    deferred.resolve(task);
    console.log("taskLoaded done");
});

pybossa.presentTask(function(task, deferred) {
    console.log("task should be presented");
    if (!$.isEmptyObject(task) ) {
        loadUserProgress();
        console.log("user progress updated");
        $('#openlayers_map').empty();
        console.log("cleared map view");
		// this will scroll down to the right place, so that we "hide" the heading.
        window.scroll(0,150);
           
		show_map(task.info.WKT, task.info.x_center, task.info.y_center);
        console.log("created map");
		
        $('#task-id').html(task.id);
        $('.btn-answer').off('click').on('click', function(evt) {
            var btn = $(this);
            var answer = btn.attr("value");
            console.log("clicked button: " + answer);
            if (typeof answer != 'undefined') {
                pybossa.saveTask(task.id, answer).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(500);
            }
            else {
                $("#error").show();
            }
        });
        
        // establish short-cuts for submission buttons
        $(document).keydown(function(e) {
            console.log(e);
            console.log(e.key);
            switch (e.key) {
                case 'a': case 'A': case 'y': case 'Y':
                    console.log(e.keyKode); $('#Sub_Yes').click();
                    return false; //"return false" will avoid further events
                case 'w': case 'W': case 'n': case 'N':
                    console.log(e.keyKode); $('#Sub_No').click();
                    return false; //"return false" will avoid further events
                case 'd': case 'D': case 'b': case 'B':
                    console.log(e.keyKode); $('#Sub_NoPhoto').click();
                    return false; //"return false" will avoid further events
            }
            return; //using "return" other attached events will execute
        });
        
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
  
    console.log("presentTask done");
});

pybossa.run('missing_maps_follow_up');


</script>
